# 08-å®ç›˜äº¤æ˜“

å®ç›˜äº¤æ˜“æ˜¯ç­–ç•¥çš„æœ€ç»ˆåº”ç”¨åœºæ™¯ã€‚æœ¬æ•™ç¨‹å°†è®²è§£å¦‚ä½•é…ç½®å’Œéƒ¨ç½²å®ç›˜äº¤æ˜“ç³»ç»Ÿï¼ŒåŒ…æ‹¬å®‰å…¨æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æ•™ç¨‹åï¼Œä½ å°†èƒ½å¤Ÿï¼š

-   âœ… ç†è§£å®ç›˜äº¤æ˜“çš„å‡†å¤‡å·¥ä½œ
-   âœ… é…ç½®çœŸå®äº¤æ˜“æ‰€è¿æ¥
-   âœ… ç®¡ç† API å¯†é’¥å®‰å…¨
-   âœ… éƒ¨ç½²å’Œç›‘æ§å®ç›˜ç³»ç»Ÿ
-   âœ… å¤„ç†å¼‚å¸¸æƒ…å†µå’Œç´§æ€¥åœæ­¢

## âš ï¸ é‡è¦è­¦å‘Š

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·åŠ¡å¿…ç†è§£ï¼š

1.  **èµ„é‡‘é£é™©**ï¼šå®ç›˜äº¤æ˜“æ¶‰åŠçœŸå®èµ„é‡‘ï¼Œå¯èƒ½é€ æˆæŸå¤±
2.  **ç³»ç»Ÿé£é™©**ï¼šç³»ç»Ÿæ•…éšœå¯èƒ½å¯¼è‡´æ„å¤–äº¤æ˜“
3.  **å¸‚åœºé£é™©**ï¼šå¸‚åœºæ³¢åŠ¨å¯èƒ½å¯¼è‡´é‡å¤§æŸå¤±
4.  **ç›‘ç®¡é£é™©**ï¼šç¡®ä¿ç¬¦åˆå½“åœ°æ³•å¾‹æ³•è§„

**å»ºè®®**ï¼š

-   å…ˆåœ¨æ¨¡æ‹Ÿç¯å¢ƒå……åˆ†æµ‹è¯•
-   ä»å°é¢èµ„é‡‘å¼€å§‹
-   è®¾ç½®ä¸¥æ ¼çš„é£é™©é™åˆ¶
-   æŒç»­ç›‘æ§ç³»ç»Ÿè¿è¡Œ

## ğŸ” å®ç›˜äº¤æ˜“å‡†å¤‡

### 1. ç¯å¢ƒé…ç½®

#### æœåŠ¡å™¨è¦æ±‚

-   **ç¨³å®šæ€§**ï¼šä½¿ç”¨ç¨³å®šçš„æœåŠ¡å™¨ï¼ˆé¿å…é¢‘ç¹æ–­çº¿ï¼‰
-   **ç½‘ç»œ**ï¼šä½å»¶è¿Ÿç½‘ç»œè¿æ¥ï¼ˆé è¿‘äº¤æ˜“æ‰€æœåŠ¡å™¨ï¼‰
-   **ç›‘æ§**ï¼šè®¾ç½®ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦
-   **å¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½é…ç½®å’Œæ•°æ®

#### å®‰å…¨æªæ–½

-   **é˜²ç«å¢™**ï¼šé™åˆ¶æœåŠ¡å™¨è®¿é—®
-   **VPN**ï¼šä½¿ç”¨ VPN ä¿æŠ¤è¿æ¥
-   **æ—¥å¿—**ï¼šå¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
-   **å®¡è®¡**ï¼šè®°å½•æ‰€æœ‰äº¤æ˜“æ“ä½œ

### 2. API å¯†é’¥ç®¡ç†

#### åˆ›å»º API å¯†é’¥

åœ¨äº¤æ˜“æ‰€åˆ›å»º API å¯†é’¥æ—¶ï¼š

-   âœ… ä»…æˆäºˆå¿…è¦çš„æƒé™ï¼ˆäº¤æ˜“ã€æŸ¥è¯¢ä½™é¢ï¼‰
-   âœ… è®¾ç½® IP ç™½åå•ï¼ˆé™åˆ¶è®¿é—®æ¥æºï¼‰
-   âœ… è®¾ç½® API å¯†é’¥æœ‰æ•ˆæœŸ
-   âŒ ä¸è¦æˆäºˆæç°æƒé™ï¼ˆé™¤éå¿…è¦ï¼‰

#### å®‰å…¨å­˜å‚¨

**æ¨èæ–¹å¼**ï¼š

```rust
// ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰
let api_key = std::env::var("EXCHANGE_API_KEY")
    .expect("EXCHANGE_API_KEY not set");
let api_secret = std::env::var("EXCHANGE_API_SECRET")
    .expect("EXCHANGE_API_SECRET not set");

// æˆ–ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆç¡®ä¿æ–‡ä»¶æƒé™å®‰å…¨ï¼‰
// ä¸è¦å°†å¯†é’¥æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ
```

**ä¸æ¨è**ï¼š

```rust
// âŒ ä¸è¦ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
let api_key = "your_api_key_here";

// âŒ ä¸è¦æäº¤åˆ° Git
// ç¡®ä¿ .gitignore åŒ…å«é…ç½®æ–‡ä»¶
```

### 3. åˆå§‹èµ„é‡‘é…ç½®

#### èµ„é‡‘åˆ†é…å»ºè®®

-   **æµ‹è¯•èµ„é‡‘**ï¼šä½¿ç”¨å°é¢èµ„é‡‘æµ‹è¯•
-   **é£é™©åˆ†æ•£**ï¼šä¸è¦å°†æ‰€æœ‰èµ„é‡‘æŠ•å…¥ä¸€ä¸ªç­–ç•¥
-   **ä¿ç•™ç¼“å†²**ï¼šä¿ç•™éƒ¨åˆ†èµ„é‡‘ä½œä¸ºç¼“å†²

## ğŸ”§ å®ç›˜é…ç½®

### é…ç½®çœŸå®äº¤æ˜“æ‰€è¿æ¥

```rust
use barter_execution::{
    client::binance::BinanceExecutionClient,
    exchange::binance::BinanceSpot,
};

// åˆ›å»ºçœŸå®æ‰§è¡Œå®¢æˆ·ç«¯é…ç½®
let execution_config = ExecutionConfig::Real {
    exchange: ExchangeId::BinanceSpot,
    api_key: api_key,
    api_secret: api_secret,
    // å…¶ä»–é…ç½®...
};

// åœ¨ SystemBuilder ä¸­ä½¿ç”¨
let system = SystemBuilder::new(args)
    .execution(execution_config)
    .build()?;
```

### é…ç½®ç³»ç»Ÿå‚æ•°

```rust
let system = SystemBuilder::new(args)
    .engine_feed_mode(EngineFeedMode::Stream)  // ä½¿ç”¨å¼‚æ­¥æ¨¡å¼
    .audit_mode(AuditMode::Enabled)            // å¯ç”¨å®¡è®¡
    .trading_state(TradingState::Disabled)     // åˆå§‹ç¦ç”¨äº¤æ˜“
    .build()?;
```

**å»ºè®®é…ç½®**ï¼š

-   ä½¿ç”¨ `EngineFeedMode::Stream` è·å¾—æ›´å¥½çš„æ€§èƒ½
-   å¯ç”¨ `AuditMode::Enabled` ç”¨äºç›‘æ§å’Œè°ƒè¯•
-   åˆå§‹çŠ¶æ€è®¾ç½®ä¸º `TradingState::Disabled`ï¼Œæ‰‹åŠ¨å¯ç”¨

## ğŸ“Š ç›‘æ§å’Œç®¡ç†

### 1. äº¤æ˜“çŠ¶æ€ç›‘æ§

```rust
// æ£€æŸ¥äº¤æ˜“çŠ¶æ€
match system.state.trading {
    TradingState::Enabled => {
        println!("âœ… äº¤æ˜“å·²å¯ç”¨");
    }
    TradingState::Disabled => {
        println!("â¸ï¸ äº¤æ˜“å·²ç¦ç”¨");
    }
}

// å¯ç”¨/ç¦ç”¨äº¤æ˜“
system.trading_state(TradingState::Enabled);
system.trading_state(TradingState::Disabled);
```

### 2. è´¦æˆ·ä½™é¢ç›‘æ§

```rust
// å®šæœŸæ£€æŸ¥è´¦æˆ·ä½™é¢
for (asset_index, asset_state) in engine.state.assets.iter() {
    if let Some(balance) = &asset_state.balance {
        println!(
            "èµ„äº§ {}: æ€»ä½™é¢={}, å¯ç”¨ä½™é¢={}",
            asset_index,
            balance.value.total,
            balance.value.free
        );
    }
}
```

### 3. æŒä»“ç›‘æ§

```rust
// æ£€æŸ¥å½“å‰æŒä»“
for (instrument_index, instrument_state) in engine.state.instruments.iter() {
    if let Some(position) = &instrument_state.position.current {
        println!(
            "äº¤æ˜“å¯¹ {}: æŒä»“={}, ç›ˆäº={}",
            instrument_index,
            position.quantity,
            position.unrealised_pnl()
        );
    }
}
```

### 4. è®¢å•ç›‘æ§

```rust
// æ£€æŸ¥æœªå®Œæˆè®¢å•
for (instrument_index, instrument_state) in engine.state.instruments.iter() {
    let open_orders = instrument_state.orders.active();
    if !open_orders.is_empty() {
        println!(
            "äº¤æ˜“å¯¹ {}: {} ä¸ªæœªå®Œæˆè®¢å•",
            instrument_index,
            open_orders.len()
        );
    }
}
```

## ğŸš¨ å¼‚å¸¸å¤„ç†

### 1. è¿æ¥æ–­å¼€å¤„ç†

å®ç° `OnDisconnectStrategy` å¤„ç†è¿æ¥æ–­å¼€ï¼š

```rust
impl OnDisconnectStrategy for MyStrategy {
    fn on_disconnect(
        &mut self,
        engine: &mut Engine,
        exchange: ExchangeId,
    ) {
        // 1. å–æ¶ˆè¯¥äº¤æ˜“æ‰€çš„æ‰€æœ‰è®¢å•
        engine.cancel_orders(InstrumentFilter::Exchanges(vec![exchange]));

        // 2. è®°å½•æ—¥å¿—
        warn!(?exchange, "äº¤æ˜“æ‰€è¿æ¥æ–­å¼€");

        // 3. å¯é€‰ï¼šç¦ç”¨äº¤æ˜“
        // engine.state.trading.update(TradingState::Disabled);
    }
}
```

### 2. ç´§æ€¥åœæ­¢æœºåˆ¶

å®ç°ç´§æ€¥åœæ­¢åŠŸèƒ½ï¼š

```rust
// æ–¹å¼ 1ï¼šç¦ç”¨äº¤æ˜“
system.trading_state(TradingState::Disabled);

// æ–¹å¼ 2ï¼šå–æ¶ˆæ‰€æœ‰è®¢å•
system.cancel_orders(InstrumentFilter::None);

// æ–¹å¼ 3ï¼šå¹³ä»“æ‰€æœ‰æŒä»“
system.close_positions(InstrumentFilter::None);

// æ–¹å¼ 4ï¼šå…³é—­ç³»ç»Ÿ
let (engine, _) = system.shutdown().await?;
```

### 3. é”™è¯¯å¤„ç†

```rust
// ç›‘æ§ç³»ç»Ÿé”™è¯¯
if let Err(error) = system_result {
    error!(?error, "ç³»ç»Ÿé”™è¯¯");

    // æ‰§è¡Œç´§æ€¥åœæ­¢
    system.trading_state(TradingState::Disabled);
    system.cancel_orders(InstrumentFilter::None);
    system.close_positions(InstrumentFilter::None);
}
```

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### 1. API å¯†é’¥å®‰å…¨

-   âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥
-   âœ… å®šæœŸè½®æ¢ API å¯†é’¥
-   âœ… é™åˆ¶ API å¯†é’¥æƒé™
-   âœ… ä½¿ç”¨ IP ç™½åå•
-   âŒ ä¸è¦å°†å¯†é’¥æäº¤åˆ°ä»£ç ä»“åº“
-   âŒ ä¸è¦åœ¨ä¸å®‰å…¨çš„ç½‘ç»œä¸­ä½¿ç”¨

### 2. ç³»ç»Ÿå®‰å…¨

-   âœ… ä½¿ç”¨é˜²ç«å¢™ä¿æŠ¤æœåŠ¡å™¨
-   âœ… å¯ç”¨ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦
-   âœ… å®šæœŸå¤‡ä»½é…ç½®å’Œæ•°æ®
-   âœ… ä½¿ç”¨ VPN ä¿æŠ¤è¿æ¥
-   âœ… é™åˆ¶ç³»ç»Ÿè®¿é—®æƒé™

### 3. èµ„é‡‘å®‰å…¨

-   âœ… è®¾ç½®ä¸¥æ ¼çš„é£é™©é™åˆ¶
-   âœ… ä½¿ç”¨å°é¢èµ„é‡‘æµ‹è¯•
-   âœ… å®šæœŸæ£€æŸ¥è´¦æˆ·ä½™é¢
-   âœ… è®¾ç½®æ­¢æŸå’Œæ­¢ç›ˆ
-   âœ… ä¸è¦å°†æ‰€æœ‰èµ„é‡‘æŠ•å…¥ä¸€ä¸ªç­–ç•¥

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

åœ¨éƒ¨ç½²å®ç›˜ç³»ç»Ÿä¹‹å‰ï¼Œè¯·ç¡®è®¤ï¼š

### ç¯å¢ƒæ£€æŸ¥

-   [ ] æœåŠ¡å™¨ç¨³å®šè¿è¡Œ
-   [ ] ç½‘ç»œè¿æ¥æ­£å¸¸
-   [ ] ç³»ç»Ÿç›‘æ§å·²é…ç½®
-   [ ] æ—¥å¿—è®°å½•å·²å¯ç”¨

### é…ç½®æ£€æŸ¥

-   [ ] API å¯†é’¥å·²æ­£ç¡®é…ç½®
-   [ ] é£é™©å‚æ•°å·²è®¾ç½®
-   [ ] äº¤æ˜“å¯¹é…ç½®æ­£ç¡®
-   [ ] åˆå§‹èµ„é‡‘å·²åˆ†é…

### å®‰å…¨æ£€æŸ¥

-   [ ] API å¯†é’¥æƒé™å·²é™åˆ¶
-   [ ] IP ç™½åå•å·²è®¾ç½®
-   [ ] é˜²ç«å¢™å·²é…ç½®
-   [ ] å¤‡ä»½æœºåˆ¶å·²å»ºç«‹

### åŠŸèƒ½æ£€æŸ¥

-   [ ] ç­–ç•¥å·²å……åˆ†æµ‹è¯•
-   [ ] é£é™©ç®¡ç†å™¨å·²å®ç°
-   [ ] å¼‚å¸¸å¤„ç†å·²å®ç°
-   [ ] ç›‘æ§ç³»ç»Ÿå·²å°±ç»ª

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šå¦‚ä½•å®‰å…¨åœ°å­˜å‚¨ API å¯†é’¥ï¼Ÿ

**è§£ç­”**ï¼š

1.  ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰
2.  ä½¿ç”¨åŠ å¯†çš„é…ç½®æ–‡ä»¶
3.  ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆå¦‚ AWS Secrets Managerï¼‰
4.  ç¡®ä¿æ–‡ä»¶æƒé™å®‰å…¨ï¼ˆchmod 600ï¼‰

### é—®é¢˜ 2ï¼šå¦‚ä½•å¤„ç†äº¤æ˜“æ‰€ API é™åˆ¶ï¼Ÿ

**è§£ç­”**ï¼š

-   éµå®ˆ API é€Ÿç‡é™åˆ¶
-   å®ç°è¯·æ±‚é‡è¯•æœºåˆ¶
-   ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥
-   ç›‘æ§ API ä½¿ç”¨æƒ…å†µ

### é—®é¢˜ 3ï¼šç³»ç»Ÿå´©æºƒæ€ä¹ˆåŠï¼Ÿ

**è§£ç­”**ï¼š

-   å®ç°è‡ªåŠ¨é‡å¯æœºåˆ¶
-   ä½¿ç”¨è¿›ç¨‹ç®¡ç†å™¨ï¼ˆå¦‚ systemdã€supervisorï¼‰
-   è®¾ç½®å¥åº·æ£€æŸ¥
-   å®ç°ä¼˜é›…å…³é—­

## âœ… æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼Œç¡®ä¿ä½ å‡†å¤‡å¥½å®ç›˜äº¤æ˜“ï¼š

-   [ ] ç†è§£å®ç›˜äº¤æ˜“çš„é£é™©
-   [ ] å·²é…ç½®å®‰å…¨çš„ API å¯†é’¥ç®¡ç†
-   [ ] å·²è®¾ç½®ä¸¥æ ¼çš„é£é™©é™åˆ¶
-   [ ] å·²å®ç°å¼‚å¸¸å¤„ç†æœºåˆ¶
-   [ ] å·²é…ç½®ç³»ç»Ÿç›‘æ§
-   [ ] å·²å……åˆ†æµ‹è¯•ç­–ç•¥

## ğŸ¯ ä¸‹ä¸€æ­¥

å®ç›˜äº¤æ˜“éƒ¨ç½²å®Œæˆåï¼Œå»ºè®®ï¼š

1.  **[09-å¸¸è§é—®é¢˜](./09-å¸¸è§é—®é¢˜.md)** - æŸ¥æ‰¾é‡åˆ°çš„é—®é¢˜
2.  **[10-æœ€ä½³å®è·µ](./10-æœ€ä½³å®è·µ.md)** - äº†è§£æ›´å¤šå¼€å‘å»ºè®®
3.  æŒç»­ç›‘æ§å’Œä¼˜åŒ–ç³»ç»Ÿ

## ğŸ“š å»¶ä¼¸é˜…è¯»

-   [Execution æ¨¡å—æ–‡æ¡£](https://docs.rs/barter-execution/latest/barter_execution/)
-   [System æ¨¡å—æ–‡æ¡£](https://docs.rs/barter/latest/barter/system/)
-   [æœ¯è¯­è¡¨](./æœ¯è¯­è¡¨.md)

---

**å®ç›˜äº¤æ˜“éœ€è¦è°¨æ…ï¼Œå®‰å…¨ç¬¬ä¸€ï¼** ğŸ›¡ï¸
