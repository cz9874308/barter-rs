# 02-æ ¸å¿ƒæ¦‚å¿µç†è§£

ç†è§£ Barter-rs çš„æ ¸å¿ƒæ¦‚å¿µæ˜¯æŒæ¡æ•´ä¸ªç³»ç»Ÿçš„å…³é”®ã€‚æœ¬æ•™ç¨‹å°†æ·±å…¥è®²è§£ Engineã€Strategyã€RiskManager ç­‰æ ¸å¿ƒç»„ä»¶ï¼Œå¸®åŠ©ä½ å»ºç«‹å®Œæ•´çš„çŸ¥è¯†ä½“ç³»ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æ•™ç¨‹åï¼Œä½ å°†èƒ½å¤Ÿï¼š

-   âœ… ç†è§£ Barter-rs çš„æ•´ä½“æ¶æ„
-   âœ… æŒæ¡ Engineï¼ˆäº¤æ˜“å¼•æ“ï¼‰çš„å·¥ä½œåŸç†
-   âœ… ç†è§£ Strategyï¼ˆäº¤æ˜“ç­–ç•¥ï¼‰çš„ä¸‰è¦ç´ 
-   âœ… äº†è§£ RiskManagerï¼ˆé£é™©ç®¡ç†å™¨ï¼‰çš„ä½œç”¨
-   âœ… ç†è§£ EngineStateï¼ˆå¼•æ“çŠ¶æ€ï¼‰çš„ç»“æ„
-   âœ… æŒæ¡ MarketEventï¼ˆå¸‚åœºäº‹ä»¶ï¼‰çš„æµè½¬è¿‡ç¨‹

## ğŸ“ æ•´ä½“æ¶æ„æ¦‚è§ˆ

åœ¨æ·±å…¥ç»†èŠ‚ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆçœ‹çœ‹ Barter-rs çš„æ•´ä½“æ¶æ„ã€‚

### ç³»ç»Ÿæ¶æ„å›¾

Barter-rs é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œç”±å¤šä¸ª crate ç»„æˆï¼š

```mermaid
graph TB
    subgraph "Barter ç”Ÿæ€ç³»ç»Ÿ"
        Barter[barter<br/>æ ¸å¿ƒäº¤æ˜“å¼•æ“]
        BarterData[barter-data<br/>å¸‚åœºæ•°æ®æµ]
        BarterExec[barter-execution<br/>è®¢å•æ‰§è¡Œ]
        BarterInst[barter-instrument<br/>äº¤æ˜“å·¥å…·]
        BarterInt[barter-integration<br/>åº•å±‚é›†æˆæ¡†æ¶]
    end

    Barter --> BarterData
    Barter --> BarterExec
    Barter --> BarterInst
    Barter --> BarterInt
    BarterData --> BarterInt
    BarterExec --> BarterInt
    BarterInst --> BarterInt

    style Barter fill:#ff6b6b,stroke:#c92a2a,stroke-width:3px,color:#fff
    style BarterData fill:#4ecdc4,stroke:#087f5b,stroke-width:2px
    style BarterExec fill:#45b7d1,stroke:#0c8599,stroke-width:2px
    style BarterInst fill:#96ceb4,stroke:#2f9e44,stroke-width:2px
    style BarterInt fill:#ffeaa7,stroke:#f59f00,stroke-width:2px
```

### æ•°æ®æµç¨‹å›¾

æ•°æ®åœ¨ç³»ç»Ÿä¸­çš„æµè½¬è¿‡ç¨‹ï¼š

```mermaid
sequenceDiagram
    participant Exchange as äº¤æ˜“æ‰€
    participant MarketStream as å¸‚åœºæ•°æ®æµ
    participant AccountStream as è´¦æˆ·äº‹ä»¶æµ
    participant Engine as Engine
    participant Strategy as Strategy
    participant RiskMgr as RiskManager
    participant ExecMgr as ExecutionManager
    participant AuditStream as å®¡è®¡æµ

    Exchange->>MarketStream: å¸‚åœºæ•°æ®<br/>(ä»·æ ¼/è®¢å•ç°¿)
    Exchange->>AccountStream: è´¦æˆ·äº‹ä»¶<br/>(ä½™é¢/è®¢å•/äº¤æ˜“)

    MarketStream->>Engine: MarketEvent
    AccountStream->>Engine: AccountEvent

    Note over Engine: æ›´æ–° EngineState

    alt TradingState::Enabled
        Engine->>Strategy: ç”Ÿæˆç®—æ³•è®¢å•
        Strategy-->>Engine: OrderRequest

        Engine->>RiskMgr: é£é™©æ£€æŸ¥
        RiskMgr-->>Engine: RiskApproved/RiskRefused

        Engine->>ExecMgr: ExecutionRequest
        ExecMgr->>Exchange: å‘é€è®¢å•

        Exchange-->>ExecMgr: è®¢å•ç¡®è®¤
        ExecMgr->>AccountStream: è´¦æˆ·æ›´æ–°
    end

    Engine->>AuditStream: AuditTick<br/>(å®¡è®¡ä¿¡æ¯)
```

## ğŸ§  Engineï¼ˆäº¤æ˜“å¼•æ“ï¼‰- ç³»ç»Ÿçš„å¤§è„‘

### ä»€ä¹ˆæ˜¯ Engineï¼Ÿ

**Engineï¼ˆäº¤æ˜“å¼•æ“ï¼‰** æ˜¯ Barter-rs çš„æ ¸å¿ƒç»„ä»¶ï¼Œå°±åƒäº¤æ˜“ç³»ç»Ÿçš„"å¤§è„‘"ã€‚å®ƒè´Ÿè´£åè°ƒæ‰€æœ‰ç»„ä»¶ï¼Œå¤„ç†äº¤æ˜“é€»è¾‘ã€‚

### ç±»æ¯”ç†è§£

æƒ³è±¡ Engine å°±åƒä¸€ä¸ªæ™ºèƒ½äº¤æ˜“åŠ©æ‰‹ï¼š

-   **æ¥æ”¶ä¿¡æ¯**ï¼šä»å¸‚åœºæ•°æ®æµå’Œè´¦æˆ·æµæ¥æ”¶æœ€æ–°ä¿¡æ¯
-   **åˆ†æå†³ç­–**ï¼šæ ¹æ®ç­–ç•¥åˆ†æå½“å‰æƒ…å†µ
-   **æ‰§è¡Œæ“ä½œ**ï¼šå‘é€è®¢å•ã€ç®¡ç†æŒä»“
-   **è®°å½•æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æ“ä½œä¾›åç»­åˆ†æ

### Engine çš„ä¸»è¦åŠŸèƒ½

1. **äº‹ä»¶å¤„ç†**ï¼šå¤„ç†å¸‚åœºäº‹ä»¶ã€è´¦æˆ·äº‹ä»¶ã€å‘½ä»¤ç­‰
2. **çŠ¶æ€ç®¡ç†**ï¼šç»´æŠ¤å®Œæ•´çš„äº¤æ˜“çŠ¶æ€ï¼ˆEngineStateï¼‰
3. **ç­–ç•¥æ‰§è¡Œ**ï¼šè°ƒç”¨ Strategy ç”Ÿæˆäº¤æ˜“è®¢å•
4. **é£é™©æ£€æŸ¥**ï¼šé€šè¿‡ RiskManager æ£€æŸ¥è®¢å•
5. **è®¢å•æ‰§è¡Œ**ï¼šå°†è®¢å•å‘é€åˆ° ExecutionManager

### Engine çš„å·¥ä½œåŸç†

Engine é‡‡ç”¨**äº‹ä»¶é©±åŠ¨æ¶æ„**ï¼š

```mermaid
flowchart TD
    Start([äº‹ä»¶æ¥æ”¶]) --> EventType{äº‹ä»¶ç±»å‹}

    EventType -->|MarketEvent| UpdateMarket[æ›´æ–°å¸‚åœºæ•°æ®]
    EventType -->|AccountEvent| UpdateAccount[æ›´æ–°è´¦æˆ·çŠ¶æ€]
    EventType -->|Command| ExecuteCommand[æ‰§è¡Œå‘½ä»¤]
    EventType -->|TradingStateUpdate| UpdateTradingState[æ›´æ–°äº¤æ˜“çŠ¶æ€]

    UpdateMarket --> UpdateState[æ›´æ–° EngineState]
    UpdateAccount --> UpdateState
    ExecuteCommand --> UpdateState
    UpdateTradingState --> CheckTradingState{äº¤æ˜“çŠ¶æ€}

    UpdateState --> CheckTradingState
    CheckTradingState -->|Enabled| GenerateOrders[Strategy ç”Ÿæˆè®¢å•]
    CheckTradingState -->|Disabled| Audit[ç”Ÿæˆå®¡è®¡ä¿¡æ¯]

    GenerateOrders --> RiskCheck[RiskManager é£é™©æ£€æŸ¥]
    RiskCheck -->|é€šè¿‡| SendOrders[å‘é€è®¢å•åˆ° ExecutionManager]
    RiskCheck -->|æ‹’ç»| LogRefused[è®°å½•æ‹’ç»åŸå› ]

    SendOrders --> Audit
    LogRefused --> Audit
    Audit --> End([å®Œæˆ])

    style Start fill:#4ecdc4,stroke:#087f5b,stroke-width:2px
    style GenerateOrders fill:#45b7d1,stroke:#0c8599,stroke-width:2px
    style RiskCheck fill:#96ceb4,stroke:#2f9e44,stroke-width:2px
    style Audit fill:#ffeaa7,stroke:#f59f00,stroke-width:2px
```

### Engine çš„ç»„æˆ

Engine åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

```rust
pub struct Engine<Clock, State, ExecutionTxs, Strategy, Risk> {
    pub clock: Clock,           // æ—¶é—´æ¥å£ï¼ˆæ”¯æŒå›æµ‹ï¼‰
    pub meta: EngineMeta,        // å…ƒæ•°æ®ï¼ˆå¯åŠ¨æ—¶é—´ã€åºåˆ—å·ï¼‰
    pub state: State,            // å¼•æ“çŠ¶æ€ï¼ˆEngineStateï¼‰
    pub execution_txs: ExecutionTxs,  // æ‰§è¡Œè¯·æ±‚å‘é€å™¨
    pub strategy: Strategy,      // äº¤æ˜“ç­–ç•¥
    pub risk: Risk,              // é£é™©ç®¡ç†å™¨
}
```

## ğŸ“Š Strategyï¼ˆäº¤æ˜“ç­–ç•¥ï¼‰- äº¤æ˜“å†³ç­–è€…

### ä»€ä¹ˆæ˜¯ Strategyï¼Ÿ

**Strategyï¼ˆäº¤æ˜“ç­–ç•¥ï¼‰** å®šä¹‰äº†**ä½•æ—¶ä¹°å…¥ã€ä½•æ—¶å–å‡º**çš„äº¤æ˜“é€»è¾‘ã€‚å®ƒæ˜¯ç®—æ³•äº¤æ˜“çš„æ ¸å¿ƒã€‚

### ç­–ç•¥ä¸‰è¦ç´ ï¼ˆå‚è€ƒ Freqtradeï¼‰

ä¸€ä¸ªå®Œæ•´çš„äº¤æ˜“ç­–ç•¥åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒè¦ç´ ï¼š

#### 1. å…¥åœºè§„åˆ™ï¼ˆEntry Logicï¼‰

**å®šä¹‰**ï¼šä»€ä¹ˆæ—¶å€™å¼€ä»“ä¹°å…¥

**ç¤ºä¾‹**ï¼š

-   ä»·æ ¼çªç ´å‰æœŸé«˜ç‚¹
-   çŸ­æœŸå‡çº¿ä¸Šç©¿é•¿æœŸå‡çº¿ï¼ˆé‡‘å‰ï¼‰
-   RSI æŒ‡æ ‡ä»è¶…å–åŒºåŸŸåå¼¹
-   æˆäº¤é‡çªç„¶æ”¾å¤§

**ä»£ç ç¤ºä¾‹**ï¼š

```rust
impl AlgoStrategy for MyStrategy {
    fn generate_algo_orders(&self, state: &EngineState) -> (Vec<OrderRequestCancel>, Vec<OrderRequestOpen>) {
        let mut opens = Vec::new();

        // éå†æ‰€æœ‰äº¤æ˜“å¯¹
        for (instrument_index, instrument_state) in state.instruments.iter() {
            // è·å–æœ€æ–°ä»·æ ¼
            if let Some(latest_price) = instrument_state.market_data.latest_price() {
                // å…¥åœºè§„åˆ™ï¼šä»·æ ¼çªç ´ 100 æ—¥å‡çº¿
                if latest_price > instrument_state.market_data.ma_100() {
                    opens.push(OrderRequestOpen {
                        // ... è®¢å•è¯¦æƒ…
                    });
                }
            }
        }

        (Vec::new(), opens)
    }
}
```

#### 2. å‡ºåœºè§„åˆ™ï¼ˆExit Logicï¼‰

**å®šä¹‰**ï¼šä»€ä¹ˆæ—¶å€™å¹³ä»“å–å‡º

**ç¤ºä¾‹**ï¼š

-   è¾¾åˆ°é¢„è®¾çš„æ­¢ç›ˆç›®æ ‡
-   è§¦å‘æ­¢æŸä»·æ ¼
-   çŸ­æœŸå‡çº¿ä¸‹ç©¿é•¿æœŸå‡çº¿ï¼ˆæ­»å‰ï¼‰
-   RSI æŒ‡æ ‡è¿›å…¥è¶…ä¹°åŒºåŸŸ

**ä»£ç ç¤ºä¾‹**ï¼š

```rust
impl AlgoStrategy for MyStrategy {
    fn generate_algo_orders(&self, state: &EngineState) -> (Vec<OrderRequestCancel>, Vec<OrderRequestOpen>) {
        let mut cancels = Vec::new();
        let mut opens = Vec::new();

        // æ£€æŸ¥ç°æœ‰æŒä»“
        for (instrument_index, instrument_state) in state.instruments.iter() {
            if let Some(position) = instrument_state.position {
                // å‡ºåœºè§„åˆ™ï¼šè¾¾åˆ° 5% æ­¢ç›ˆ
                if position.unrealized_pnl_percent() >= 5.0 {
                    // ç”Ÿæˆå¹³ä»“è®¢å•
                    opens.push(OrderRequestOpen {
                        side: Side::Sell,  // å–å‡ºå¹³ä»“
                        // ... å…¶ä»–è®¢å•è¯¦æƒ…
                    });
                }
            }
        }

        (cancels, opens)
    }
}
```

#### 3. é£é™©ç®¡ç†ï¼ˆRisk Managementï¼‰

**å®šä¹‰**ï¼šæ§åˆ¶æ¯ç¬”äº¤æ˜“çš„é£é™©æš´éœ²

**åŒ…æ‹¬**ï¼š

-   **ä»“ä½å¤§å°**ï¼šæ¯æ¬¡ä¹°å…¥å¤šå°‘
-   **æ­¢æŸè®¾ç½®**ï¼šæœ€å¤§äºæŸå®¹å¿åº¦
-   **æ­¢ç›ˆè®¾ç½®**ï¼šç›®æ ‡ç›ˆåˆ©æ°´å¹³
-   **æœ€å¤§æŒä»“æ•°**ï¼šåŒæ—¶æŒæœ‰å¤šå°‘ä¸ªäº¤æ˜“å¯¹

**ä»£ç ç¤ºä¾‹**ï¼š

```rust
impl AlgoStrategy for MyStrategy {
    fn generate_algo_orders(&self, state: &EngineState) -> (Vec<OrderRequestCancel>, Vec<OrderRequestOpen>) {
        let mut opens = Vec::new();

        // é£é™©ç®¡ç†ï¼šé™åˆ¶æ¯æ¬¡ä¹°å…¥é‡‘é¢ä¸è¶…è¿‡æ€»èµ„é‡‘çš„ 10%
        let total_balance = state.assets.get(&usdt_index).balance.total;
        let max_order_value = total_balance * Decimal::from(10) / Decimal::from(100);

        for (instrument_index, instrument_state) in state.instruments.iter() {
            if should_buy(instrument_state) {
                // è®¡ç®—è®¢å•æ•°é‡ï¼Œç¡®ä¿ä¸è¶…è¿‡æœ€å¤§é‡‘é¢
                let order_quantity = calculate_quantity(max_order_value, instrument_state.latest_price());

                opens.push(OrderRequestOpen {
                    quantity: order_quantity,
                    // ... å…¶ä»–è®¢å•è¯¦æƒ…
                });
            }
        }

        (Vec::new(), opens)
    }
}
```

### Strategy Trait æ¥å£

æ‰€æœ‰ç­–ç•¥éƒ½å¿…é¡»å®ç° `AlgoStrategy` traitï¼š

```rust
pub trait AlgoStrategy<ExchangeKey, InstrumentKey> {
    type State;  // ç­–ç•¥ä½¿ç”¨çš„çŠ¶æ€ç±»å‹ï¼ˆé€šå¸¸æ˜¯ EngineStateï¼‰

    fn generate_algo_orders(
        &self,
        state: &Self::State,
    ) -> (
        impl IntoIterator<Item = OrderRequestCancel<ExchangeKey, InstrumentKey>>,
        impl IntoIterator<Item = OrderRequestOpen<ExchangeKey, InstrumentKey>>,
    );
}
```

### ç­–ç•¥ç”Ÿå‘½å‘¨æœŸ

ç­–ç•¥ä»è®¾è®¡åˆ°å®ç›˜çš„å®Œæ•´æµç¨‹ï¼š

```mermaid
graph LR
    A[ç­–ç•¥è®¾è®¡] --> B[ç¼–ç å®ç°]
    B --> C[å›æµ‹éªŒè¯]
    C --> D[å‚æ•°ä¼˜åŒ–]
    D --> E[æ¨¡æ‹Ÿäº¤æ˜“]
    E --> F[å®ç›˜éƒ¨ç½²]
    F --> G[ç›‘æ§è°ƒæ•´]
    G --> A

    style A fill:#4ecdc4,stroke:#087f5b,stroke-width:2px
    style C fill:#45b7d1,stroke:#0c8599,stroke-width:2px
    style E fill:#96ceb4,stroke:#2f9e44,stroke-width:2px
    style F fill:#ffeaa7,stroke:#f59f00,stroke-width:2px
```

## ğŸ›¡ï¸ RiskManagerï¼ˆé£é™©ç®¡ç†å™¨ï¼‰- å®‰å…¨å«å£«

### ä»€ä¹ˆæ˜¯ RiskManagerï¼Ÿ

**RiskManagerï¼ˆé£é™©ç®¡ç†å™¨ï¼‰** æ˜¯äº¤æ˜“ç³»ç»Ÿçš„"å®‰å…¨å«å£«"ï¼Œè´Ÿè´£æ£€æŸ¥ç­–ç•¥ç”Ÿæˆçš„è®¢å•æ˜¯å¦ç¬¦åˆé£é™©è¦æ±‚ã€‚

### ç±»æ¯”ç†è§£

æƒ³è±¡ RiskManager å°±åƒé“¶è¡Œçš„è´·æ¬¾å®¡æ ¸å‘˜ï¼š

-   **æ£€æŸ¥ç”³è¯·**ï¼šå®¡æŸ¥æ¯ç¬”è®¢å•è¯·æ±‚
-   **è¯„ä¼°é£é™©**ï¼šåˆ¤æ–­æ˜¯å¦å®‰å…¨
-   **æ‰¹å‡†æˆ–æ‹’ç»**ï¼šé€šè¿‡æˆ–æ‹’ç»è®¢å•
-   **è®°å½•åŸå› **ï¼šè®°å½•æ‹’ç»çš„åŸå› 

### RiskManager çš„ä½œç”¨

1. **è¿‡æ»¤é«˜é£é™©è®¢å•**ï¼šæ‹’ç»å¯èƒ½å¯¼è‡´è¿‡åº¦é£é™©çš„è®¢å•
2. **é™åˆ¶è®¢å•æ•°é‡**ï¼šé˜²æ­¢å•ç¬”è®¢å•è¿‡å¤§
3. **æ£€æŸ¥æŒä»“é™åˆ¶**ï¼šç¡®ä¿ä¸è¶…è¿‡æœ€å¤§æŒä»“æ•°
4. **èµ„é‡‘ç®¡ç†**ï¼šç¡®ä¿æœ‰è¶³å¤Ÿçš„èµ„é‡‘æ‰§è¡Œè®¢å•

### RiskManager å·¥ä½œæµç¨‹

```mermaid
flowchart TD
    Start([ç­–ç•¥ç”Ÿæˆè®¢å•]) --> RiskCheck[RiskManager æ£€æŸ¥]

    RiskCheck --> Check1{è®¢å•æ•°é‡<br/>æ˜¯å¦è¿‡å¤§?}
    Check1 -->|æ˜¯| Refuse1[æ‹’ç»è®¢å•]
    Check1 -->|å¦| Check2{æŒä»“æ˜¯å¦<br/>è¶…é™?}

    Check2 -->|æ˜¯| Refuse2[æ‹’ç»è®¢å•]
    Check2 -->|å¦| Check3{èµ„é‡‘æ˜¯å¦<br/>å……è¶³?}

    Check3 -->|å¦| Refuse3[æ‹’ç»è®¢å•]
    Check3 -->|æ˜¯| Check4{å…¶ä»–é£é™©<br/>æ£€æŸ¥}

    Check4 -->|ä¸é€šè¿‡| Refuse4[æ‹’ç»è®¢å•]
    Check4 -->|é€šè¿‡| Approve[æ‰¹å‡†è®¢å•]

    Refuse1 --> Log[è®°å½•æ‹’ç»åŸå› ]
    Refuse2 --> Log
    Refuse3 --> Log
    Refuse4 --> Log

    Approve --> Send[å‘é€åˆ° ExecutionManager]
    Log --> End([å®Œæˆ])
    Send --> End

    style RiskCheck fill:#96ceb4,stroke:#2f9e44,stroke-width:2px
    style Approve fill:#4ecdc4,stroke:#087f5b,stroke-width:2px
    style Refuse1 fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px
    style Refuse2 fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px
    style Refuse3 fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px
    style Refuse4 fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px
```

### RiskManager Trait æ¥å£

```rust
pub trait RiskManager<ExchangeKey, InstrumentKey> {
    type State;  // é£é™©ç®¡ç†å™¨ä½¿ç”¨çš„çŠ¶æ€ç±»å‹

    fn check(
        &self,
        state: &Self::State,
        cancels: impl IntoIterator<Item = OrderRequestCancel<ExchangeKey, InstrumentKey>>,
        opens: impl IntoIterator<Item = OrderRequestOpen<ExchangeKey, InstrumentKey>>,
    ) -> (
        impl IntoIterator<Item = RiskApproved<OrderRequestCancel<...>>>,
        impl IntoIterator<Item = RiskApproved<OrderRequestOpen<...>>>,
        impl IntoIterator<Item = RiskRefused<OrderRequestCancel<...>>>,
        impl IntoIterator<Item = RiskRefused<OrderRequestOpen<...>>>,
    );
}
```

### é£é™©æ£€æŸ¥ç¤ºä¾‹

```rust
impl RiskManager for MyRiskManager {
    type State = EngineState<DefaultGlobalData, DefaultInstrumentMarketData>;

    fn check(
        &self,
        state: &Self::State,
        cancels: impl IntoIterator<Item = OrderRequestCancel>,
        opens: impl IntoIterator<Item = OrderRequestOpen>,
    ) -> (Vec<RiskApproved<...>>, Vec<RiskApproved<...>>, Vec<RiskRefused<...>>, Vec<RiskRefused<...>>) {
        let mut approved_opens = Vec::new();
        let mut refused_opens = Vec::new();

        for order in opens {
            // æ£€æŸ¥ 1ï¼šè®¢å•æ•°é‡æ˜¯å¦è¶…è¿‡é™åˆ¶
            if order.quantity > self.max_order_quantity {
                refused_opens.push(RiskRefused::new(
                    order,
                    format!("è®¢å•æ•°é‡ {} è¶…è¿‡æœ€å¤§é™åˆ¶ {}", order.quantity, self.max_order_quantity)
                ));
                continue;
            }

            // æ£€æŸ¥ 2ï¼šæŒä»“æ˜¯å¦è¶…é™
            if state.instruments.get(&order.instrument).position_count() >= self.max_positions {
                refused_opens.push(RiskRefused::new(
                    order,
                    "æŒä»“æ•°é‡å·²è¾¾ä¸Šé™"
                ));
                continue;
            }

            // æ£€æŸ¥ 3ï¼šèµ„é‡‘æ˜¯å¦å……è¶³
            let required_funds = order.quantity * order.price;
            let available_balance = state.assets.get(&usdt_index).balance.free;
            if required_funds > available_balance {
                refused_opens.push(RiskRefused::new(
                    order,
                    format!("èµ„é‡‘ä¸è¶³ï¼šéœ€è¦ {}ï¼Œå¯ç”¨ {}", required_funds, available_balance)
                ));
                continue;
            }

            // æ‰€æœ‰æ£€æŸ¥é€šè¿‡
            approved_opens.push(RiskApproved::new(order));
        }

        (Vec::new(), approved_opens, Vec::new(), refused_opens)
    }
}
```

## ğŸ’¾ EngineStateï¼ˆå¼•æ“çŠ¶æ€ï¼‰- ç³»ç»Ÿè®°å¿†

### ä»€ä¹ˆæ˜¯ EngineStateï¼Ÿ

**EngineStateï¼ˆå¼•æ“çŠ¶æ€ï¼‰** æ˜¯ Engine çš„"è®°å¿†"ï¼Œç»´æŠ¤äº†ç³»ç»Ÿçš„å®Œæ•´çŠ¶æ€ä¿¡æ¯ã€‚

### EngineState çš„ç»“æ„

```mermaid
graph TD
    EngineState[EngineState<br/>å¼•æ“çŠ¶æ€] --> TradingState[TradingState<br/>äº¤æ˜“çŠ¶æ€<br/>Enabled/Disabled]
    EngineState --> GlobalData[GlobalData<br/>å…¨å±€æ•°æ®<br/>ç”¨æˆ·è‡ªå®šä¹‰]
    EngineState --> Connectivity[ConnectivityStates<br/>è¿æ¥çŠ¶æ€<br/>å¥åº·æ£€æŸ¥]
    EngineState --> Assets[AssetStates<br/>èµ„äº§çŠ¶æ€<br/>å¸¸é‡æ—¶é—´ç´¢å¼•æŸ¥æ‰¾]
    EngineState --> Instruments[InstrumentStates<br/>äº¤æ˜“å¯¹çŠ¶æ€<br/>å¸¸é‡æ—¶é—´ç´¢å¼•æŸ¥æ‰¾]

    Assets --> Asset1[Asset: BTC<br/>ä½™é¢ã€ç»Ÿè®¡ä¿¡æ¯]
    Assets --> Asset2[Asset: USDT<br/>ä½™é¢ã€ç»Ÿè®¡ä¿¡æ¯]
    Assets --> AssetN[Asset: ...]

    Instruments --> Inst1[Instrument: BTC/USDT<br/>æŒä»“ã€è®¢å•ã€å¸‚åœºæ•°æ®]
    Instruments --> Inst2[Instrument: ETH/USDT<br/>æŒä»“ã€è®¢å•ã€å¸‚åœºæ•°æ®]
    Instruments --> InstN[Instrument: ...]

    Inst1 --> Position1[Position<br/>æŒä»“ä¿¡æ¯]
    Inst1 --> Order1[OrderManager<br/>è®¢å•ç®¡ç†]
    Inst1 --> MarketData1[MarketData<br/>å¸‚åœºæ•°æ®]

    style EngineState fill:#ff6b6b,stroke:#c92a2a,stroke-width:3px,color:#fff
    style Assets fill:#4ecdc4,stroke:#087f5b,stroke-width:2px
    style Instruments fill:#45b7d1,stroke:#0c8599,stroke-width:2px
```

### EngineState çš„ç»„æˆéƒ¨åˆ†

#### 1. TradingStateï¼ˆäº¤æ˜“çŠ¶æ€ï¼‰

æ§åˆ¶ç®—æ³•äº¤æ˜“æ˜¯å¦å¯ç”¨ï¼š

```rust
pub enum TradingState {
    Enabled,   // å¯ç”¨ï¼šStrategy ä¼šç”Ÿæˆè®¢å•
    Disabled,  // ç¦ç”¨ï¼šStrategy ä¸ä¼šç”Ÿæˆè®¢å•
}
```

#### 2. AssetStatesï¼ˆèµ„äº§çŠ¶æ€ï¼‰

ç®¡ç†æ‰€æœ‰èµ„äº§çš„çŠ¶æ€ï¼ˆå¦‚ BTCã€USDTï¼‰ï¼š

-   **ä½™é¢ä¿¡æ¯**ï¼šæ€»ä½™é¢ã€å¯ç”¨ä½™é¢
-   **ç»Ÿè®¡ä¿¡æ¯**ï¼šç›ˆäºã€äº¤æ˜“æ¬¡æ•°ç­‰
-   **ç´¢å¼•æŸ¥æ‰¾**ï¼šä½¿ç”¨ `FnvHashMap` å®ç° O(1) å¿«é€ŸæŸ¥æ‰¾

#### 3. InstrumentStatesï¼ˆäº¤æ˜“å¯¹çŠ¶æ€ï¼‰

ç®¡ç†æ‰€æœ‰äº¤æ˜“å¯¹çš„çŠ¶æ€ï¼ˆå¦‚ BTC/USDTï¼‰ï¼š

-   **æŒä»“ä¿¡æ¯**ï¼šå½“å‰æŒä»“ã€ç›ˆäº
-   **è®¢å•ç®¡ç†**ï¼šæœªå®Œæˆè®¢å•ã€è®¢å•å†å²
-   **å¸‚åœºæ•°æ®**ï¼šæœ€æ–°ä»·æ ¼ã€è®¢å•ç°¿ç­‰

#### 4. ConnectivityStatesï¼ˆè¿æ¥çŠ¶æ€ï¼‰

è·Ÿè¸ªç³»ç»Ÿè¿æ¥å¥åº·çŠ¶æ€ï¼š

-   **å…¨å±€è¿æ¥çŠ¶æ€**ï¼šæ•´ä½“ç³»ç»Ÿæ˜¯å¦æ­£å¸¸
-   **äº¤æ˜“æ‰€è¿æ¥çŠ¶æ€**ï¼šæ¯ä¸ªäº¤æ˜“æ‰€çš„å¸‚åœºæ•°æ®å’Œè´¦æˆ·è¿æ¥çŠ¶æ€

### çŠ¶æ€æ›´æ–°æµç¨‹

```mermaid
sequenceDiagram
    participant Event as äº‹ä»¶
    participant Engine as Engine
    participant State as EngineState

    Event->>Engine: MarketEvent/AccountEvent
    Engine->>State: update_from_market()<br/>update_from_account()
    State->>State: æ›´æ–°èµ„äº§çŠ¶æ€
    State->>State: æ›´æ–°äº¤æ˜“å¯¹çŠ¶æ€
    State->>State: æ›´æ–°è¿æ¥çŠ¶æ€
    State-->>Engine: çŠ¶æ€å·²æ›´æ–°
    Engine->>Engine: ä½¿ç”¨æ–°çŠ¶æ€ç”Ÿæˆè®¢å•
```

## ğŸ“¨ MarketEventï¼ˆå¸‚åœºäº‹ä»¶ï¼‰- å¸‚åœºä¿¡æ¯

### ä»€ä¹ˆæ˜¯ MarketEventï¼Ÿ

**MarketEventï¼ˆå¸‚åœºäº‹ä»¶ï¼‰** åŒ…å«å¸‚åœºæ•°æ®çš„æ›´æ–°ä¿¡æ¯ï¼Œå¦‚ä»·æ ¼å˜åŠ¨ã€è®¢å•ç°¿æ›´æ–°ç­‰ã€‚

### MarketEvent çš„ç±»å‹

```rust
pub enum DataKind {
    PublicTrades,    // é€ç¬”äº¤æ˜“æ•°æ®
    OrderBooksL1,    // ä¸€çº§è®¢å•ç°¿ï¼ˆæœ€ä½³ä¹°å–ä»·ï¼‰
    OrderBooksL2,    // äºŒçº§è®¢å•ç°¿ï¼ˆæ·±åº¦æ•°æ®ï¼‰
    // ... å…¶ä»–ç±»å‹
}
```

### å¸‚åœºäº‹ä»¶æµè½¬

```mermaid
graph LR
    Exchange[äº¤æ˜“æ‰€] -->|WebSocket| MarketStream[MarketStream]
    MarketStream -->|MarketEvent| Engine[Engine]
    Engine -->|æ›´æ–°çŠ¶æ€| EngineState[EngineState]
    EngineState -->|æä¾›æ•°æ®| Strategy[Strategy]

    style Exchange fill:#4ecdc4,stroke:#087f5b,stroke-width:2px
    style MarketStream fill:#45b7d1,stroke:#0c8599,stroke-width:2px
    style Engine fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px
```

## ğŸ”— æ ¸å¿ƒæ¦‚å¿µå…³ç³»å›¾

æ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µå¦‚ä½•åä½œï¼š

```mermaid
graph TB
    MarketStream[MarketStream<br/>å¸‚åœºæ•°æ®æµ] --> Engine[Engine<br/>äº¤æ˜“å¼•æ“]
    AccountStream[AccountStream<br/>è´¦æˆ·äº‹ä»¶æµ] --> Engine

    Engine --> EngineState[EngineState<br/>å¼•æ“çŠ¶æ€]
    Engine --> Strategy[Strategy<br/>äº¤æ˜“ç­–ç•¥]
    Engine --> RiskManager[RiskManager<br/>é£é™©ç®¡ç†å™¨]

    Strategy -->|ç”Ÿæˆè®¢å•| RiskManager
    RiskManager -->|æ‰¹å‡†è®¢å•| ExecutionManager[ExecutionManager<br/>æ‰§è¡Œç®¡ç†å™¨]
    ExecutionManager -->|å‘é€è®¢å•| Exchange[äº¤æ˜“æ‰€]

    EngineState -->|æä¾›çŠ¶æ€| Strategy
    EngineState -->|æä¾›çŠ¶æ€| RiskManager

    style Engine fill:#ff6b6b,stroke:#c92a2a,stroke-width:3px,color:#fff
    style Strategy fill:#45b7d1,stroke:#0c8599,stroke-width:2px
    style RiskManager fill:#96ceb4,stroke:#2f9e44,stroke-width:2px
    style EngineState fill:#4ecdc4,stroke:#087f5b,stroke-width:2px
```

## ğŸ’¡ å…³é”®è¦ç‚¹æ€»ç»“

### Engineï¼ˆäº¤æ˜“å¼•æ“ï¼‰

-   âœ… æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œåè°ƒæ‰€æœ‰ç»„ä»¶
-   âœ… é‡‡ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„
-   âœ… å¤„ç†äº‹ä»¶ã€ç»´æŠ¤çŠ¶æ€ã€ç”Ÿæˆè®¢å•

### Strategyï¼ˆäº¤æ˜“ç­–ç•¥ï¼‰

-   âœ… åŒ…å«ä¸‰è¦ç´ ï¼šå…¥åœºè§„åˆ™ã€å‡ºåœºè§„åˆ™ã€é£é™©ç®¡ç†
-   âœ… å®ç° `AlgoStrategy` trait
-   âœ… æ ¹æ® EngineState ç”Ÿæˆè®¢å•è¯·æ±‚

### RiskManagerï¼ˆé£é™©ç®¡ç†å™¨ï¼‰

-   âœ… æ£€æŸ¥è®¢å•æ˜¯å¦ç¬¦åˆé£é™©è¦æ±‚
-   âœ… è¿”å› `RiskApproved` æˆ– `RiskRefused`
-   âœ… è®°å½•æ‹’ç»åŸå› ï¼Œä¾¿äºè°ƒè¯•

### EngineStateï¼ˆå¼•æ“çŠ¶æ€ï¼‰

-   âœ… ç»´æŠ¤ç³»ç»Ÿçš„å®Œæ•´çŠ¶æ€
-   âœ… ä½¿ç”¨ç´¢å¼•ç»“æ„å®ç°å¿«é€ŸæŸ¥æ‰¾
-   âœ… åŒ…å«èµ„äº§çŠ¶æ€ã€äº¤æ˜“å¯¹çŠ¶æ€ã€è¿æ¥çŠ¶æ€

### MarketEventï¼ˆå¸‚åœºäº‹ä»¶ï¼‰

-   âœ… åŒ…å«å¸‚åœºæ•°æ®æ›´æ–°
-   âœ… é€šè¿‡ MarketStream æµå…¥ Engine
-   âœ… è§¦å‘çŠ¶æ€æ›´æ–°å’Œç­–ç•¥æ‰§è¡Œ

## ğŸ“ ç»ƒä¹ å»ºè®®

1. **ç†è§£æµç¨‹**ï¼šç”»å‡ºæ•°æ®ä»äº¤æ˜“æ‰€åˆ°è®¢å•æ‰§è¡Œçš„å®Œæ•´æµç¨‹
2. **åˆ†æç¤ºä¾‹**ï¼šæŸ¥çœ‹é¡¹ç›®ä¸­çš„ç¤ºä¾‹ä»£ç ï¼Œç†è§£æ¯ä¸ªç»„ä»¶çš„ä½œç”¨
3. **æ€è€ƒè®¾è®¡**ï¼šæ€è€ƒä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

## ğŸ¯ ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»ç†è§£äº†æ ¸å¿ƒæ¦‚å¿µï¼Œå¯ä»¥å¼€å§‹ç¼–å†™ä½ çš„ç¬¬ä¸€ä¸ªäº¤æ˜“ç­–ç•¥äº†ï¼

â†’ [03-ç¬¬ä¸€ä¸ªäº¤æ˜“ç­–ç•¥](./03-ç¬¬ä¸€ä¸ªäº¤æ˜“ç­–ç•¥.md)

## ğŸ“š å»¶ä¼¸é˜…è¯»

-   [Engine æ¨¡å—æ–‡æ¡£](https://docs.rs/barter/latest/barter/engine/)
-   [Strategy æ¨¡å—æ–‡æ¡£](https://docs.rs/barter/latest/barter/strategy/)
-   [RiskManager æ¨¡å—æ–‡æ¡£](https://docs.rs/barter/latest/barter/risk/)
-   [æœ¯è¯­è¡¨](./æœ¯è¯­è¡¨.md)

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹ç¼–å†™ç¬¬ä¸€ä¸ªç­–ç•¥ï¼** ğŸš€
