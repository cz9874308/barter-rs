# 07-å›æµ‹ç³»ç»Ÿ

å›æµ‹æ˜¯éªŒè¯ç­–ç•¥æœ‰æ•ˆæ€§çš„å…³é”®æ­¥éª¤ã€‚æœ¬æ•™ç¨‹å°†æ·±å…¥è®²è§£å¦‚ä½•ä½¿ç”¨ Barter-rs çš„å›æµ‹ç³»ç»Ÿï¼Œä½¿ç”¨å†å²æ•°æ®æµ‹è¯•ç­–ç•¥æ€§èƒ½ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æ•™ç¨‹åï¼Œä½ å°†èƒ½å¤Ÿï¼š

-   âœ… ç†è§£å›æµ‹çš„æ¦‚å¿µå’Œä½œç”¨
-   âœ… å‡†å¤‡å†å²å¸‚åœºæ•°æ®
-   âœ… è¿è¡Œå•ä¸ªå›æµ‹
-   âœ… è¿è¡Œæ‰¹é‡å¹¶å‘å›æµ‹
-   âœ… åˆ†æå›æµ‹ç»“æœå’Œæ€§èƒ½æŒ‡æ ‡
-   âœ… ä¼˜åŒ–ç­–ç•¥å‚æ•°

## ğŸ”„ å›æµ‹æ¦‚è¿°

### ä»€ä¹ˆæ˜¯å›æµ‹ï¼Ÿ

**å›æµ‹ï¼ˆBacktestingï¼‰** æ˜¯ä½¿ç”¨å†å²æ•°æ®æ¨¡æ‹Ÿäº¤æ˜“ç­–ç•¥çš„è¿‡ç¨‹ã€‚å®ƒè®©ä½ èƒ½å¤Ÿï¼š

-   éªŒè¯ç­–ç•¥åœ¨å†å²æ•°æ®ä¸Šçš„è¡¨ç°
-   ä¼˜åŒ–ç­–ç•¥å‚æ•°
-   è¯„ä¼°ç­–ç•¥é£é™©
-   é¿å…åœ¨å®ç›˜ä¸Šæµ‹è¯•ç­–ç•¥

### å›æµ‹ vs å®ç›˜äº¤æ˜“

| ç‰¹æ€§     | å›æµ‹           | å®ç›˜äº¤æ˜“       |
| -------- | -------------- | -------------- |
| æ•°æ®æ¥æº | å†å²æ•°æ®       | å®æ—¶æ•°æ®       |
| æ‰§è¡Œæ–¹å¼ | æ¨¡æ‹Ÿæ‰§è¡Œ       | çœŸå®æ‰§è¡Œ       |
| æ—¶é—´æ§åˆ¶ | å¯ä»¥åŠ é€Ÿ       | å®æ—¶           |
| æˆæœ¬     | æ— èµ„é‡‘æˆæœ¬     | æœ‰çœŸå®èµ„é‡‘é£é™© |
| ç”¨é€”     | ç­–ç•¥éªŒè¯å’Œä¼˜åŒ– | å®é™…äº¤æ˜“       |

### å›æµ‹çš„å±€é™æ€§

âš ï¸ **é‡è¦æé†’**ï¼šå›æµ‹ç»“æœä¸èƒ½ä¿è¯æœªæ¥è¡¨ç°

-   å†å²æ•°æ®å¯èƒ½ä¸å®Œæ•´
-   æ— æ³•æ¨¡æ‹Ÿæ»‘ç‚¹å’ŒæµåŠ¨æ€§é—®é¢˜
-   æ— æ³•è€ƒè™‘å¸‚åœºæƒ…ç»ªå’Œçªå‘äº‹ä»¶
-   å¯èƒ½å­˜åœ¨è¿‡æ‹Ÿåˆé£é™©

## ğŸ“Š å›æµ‹ç³»ç»Ÿæ¶æ„

### å›æµ‹æµç¨‹

```mermaid
flowchart TD
    Start([å¼€å§‹å›æµ‹]) --> LoadData[åŠ è½½å†å²æ•°æ®]
    LoadData --> CreateClock[åˆ›å»º HistoricalClock]
    CreateClock --> CreateEngine[åˆ›å»º Engine]
    CreateEngine --> CreateSystem[åˆ›å»º System]
    CreateSystem --> ProcessEvents[å¤„ç†å†å²äº‹ä»¶]
    ProcessEvents --> GenerateOrders[ç”Ÿæˆè®¢å•]
    GenerateOrders --> SimulateExecution[æ¨¡æ‹Ÿæ‰§è¡Œ]
    SimulateExecution --> UpdateState[æ›´æ–°çŠ¶æ€]
    UpdateState --> MoreEvents{è¿˜æœ‰äº‹ä»¶?}
    MoreEvents -->|æ˜¯| ProcessEvents
    MoreEvents -->|å¦| GenerateSummary[ç”Ÿæˆäº¤æ˜“æ‘˜è¦]
    GenerateSummary --> End([å›æµ‹å®Œæˆ])

    style Start fill:#4ecdc4,stroke:#087f5b,stroke-width:2px
    style GenerateSummary fill:#45b7d1,stroke:#0c8599,stroke-width:2px
    style End fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px
```

### æ ¸å¿ƒç»„ä»¶

1.  **HistoricalClock**ï¼šå†å²æ—¶é’Ÿï¼Œä½¿ç”¨å†å²äº‹ä»¶çš„æ—¶é—´æˆ³
2.  **BacktestMarketData**ï¼šå›æµ‹å¸‚åœºæ•°æ®æ¥å£
3.  **MockExecutionClient**ï¼šæ¨¡æ‹Ÿæ‰§è¡Œå®¢æˆ·ç«¯
4.  **TradingSummary**ï¼šäº¤æ˜“æ‘˜è¦å’Œæ€§èƒ½æŒ‡æ ‡

## ğŸ“ å‡†å¤‡å†å²æ•°æ®

### æ•°æ®æ ¼å¼

å†å²æ•°æ®åº”è¯¥æ˜¯ `MarketStreamEvent` çš„é›†åˆï¼š

```rust
// æ¯è¡Œä¸€ä¸ª JSON æ ¼å¼çš„ MarketStreamEvent
{"time_exchange":"2024-01-01T00:00:00Z","time_received":"2024-01-01T00:00:00Z","exchange":"BinanceSpot","instrument":...,"kind":...}
{"time_exchange":"2024-01-01T00:00:01Z","time_received":"2024-01-01T00:00:01Z","exchange":"BinanceSpot","instrument":...,"kind":...}
```

### ä»æ–‡ä»¶åŠ è½½æ•°æ®

```rust
use barter_data::streams::consumer::MarketStreamEvent;
use std::{fs::File, io::BufReader};

fn load_market_data_from_file<InstrumentKey, Kind>(
    file_path: &str,
) -> Vec<MarketStreamEvent<InstrumentKey, Kind>>
where
    InstrumentKey: for<'de> serde::Deserialize<'de>,
    Kind: for<'de> serde::Deserialize<'de>,
{
    let file = File::open(file_path).unwrap();
    let reader = BufReader::new(file);

    reader
        .lines()
        .map(|line_result| {
            let line = line_result.unwrap();
            serde_json::from_str::<MarketStreamEvent<InstrumentKey, Kind>>(&line).unwrap()
        })
        .collect()
}
```

### åˆ›å»ºå›æµ‹å¸‚åœºæ•°æ®

```rust
use barter::backtest::market_data::MarketDataInMemory;
use std::sync::Arc;

let market_events = load_market_data_from_file("path/to/market_data.json");
let market_data = MarketDataInMemory::new(Arc::new(market_events));
```

## ğŸš€ è¿è¡Œå•ä¸ªå›æµ‹

### åŸºæœ¬å›æµ‹ç¤ºä¾‹

```rust
use barter::{
    backtest::{
        BacktestArgsConstant, BacktestArgsDynamic,
        market_data::MarketDataInMemory,
        backtest,
    },
    engine::state::{
        EngineState, builder::EngineStateBuilder,
        global::DefaultGlobalData,
        instrument::data::DefaultInstrumentMarketData,
        trading::TradingState,
    },
    risk::DefaultRiskManager,
    statistic::time::Daily,
    strategy::DefaultStrategy,
    system::config::SystemConfig,
};
use barter_instrument::index::IndexedInstruments;
use rust_decimal::Decimal;
use rust_decimal_macros::dec;
use std::sync::Arc;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // 1. åŠ è½½é…ç½®
    let SystemConfig { instruments, executions } = load_config()?;
    let instruments = IndexedInstruments::new(instruments);

    // 2. å‡†å¤‡å†å²å¸‚åœºæ•°æ®
    let market_events = load_market_data_from_file("market_data.json");
    let market_data = MarketDataInMemory::new(Arc::new(market_events));
    let time_start = market_data.time_first_event().await?;

    // 3. æ„å»º EngineState
    let engine_state = EngineState::builder(
        &instruments,
        DefaultGlobalData::default(),
        |_| DefaultInstrumentMarketData::default(),
    )
    .time_engine_start(time_start)
    .trading_state(TradingState::Enabled)
    .build();

    // 4. æ„å»ºå¸¸é‡å‚æ•°
    let args_constant = Arc::new(BacktestArgsConstant {
        instruments,
        executions,
        market_data,
        summary_interval: Daily,
        engine_state,
    });

    // 5. æ„å»ºåŠ¨æ€å‚æ•°ï¼ˆç­–ç•¥å’Œé£é™©ç®¡ç†å™¨ï¼‰
    let args_dynamic = BacktestArgsDynamic {
        id: "my_backtest".into(),
        risk_free_return: dec!(0.05),  // 5% æ— é£é™©æ”¶ç›Šç‡
        strategy: MyStrategy::new(),
        risk: MyRiskManager::new(),
    };

    // 6. è¿è¡Œå›æµ‹
    let summary = backtest(args_constant, args_dynamic).await?;

    // 7. åˆ†æç»“æœ
    println!("å›æµ‹ ID: {}", summary.id);
    summary.trading_summary.print_summary();

    Ok(())
}
```

## ğŸ”„ è¿è¡Œæ‰¹é‡å¹¶å‘å›æµ‹

### å¹¶å‘å›æµ‹ç¤ºä¾‹

å½“ä½ éœ€è¦æµ‹è¯•å¤šä¸ªç­–ç•¥å‚æ•°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¹¶å‘å›æµ‹ï¼š

```rust
use barter::backtest::run_backtests;

// æ„å»ºå¸¸é‡å‚æ•°ï¼ˆæ‰€æœ‰å›æµ‹å…±äº«ï¼‰
let args_constant = Arc::new(BacktestArgsConstant {
    instruments,
    executions,
    market_data,
    summary_interval: Daily,
    engine_state,
});

// æ„å»ºåŠ¨æ€å‚æ•°è¿­ä»£å™¨ï¼ˆæ¯ä¸ªå›æµ‹ä¸åŒï¼‰
let args_dynamic_iter = vec![
    BacktestArgsDynamic {
        id: "strategy_v1".into(),
        risk_free_return: dec!(0.05),
        strategy: StrategyV1::new(),
        risk: RiskManagerV1::new(),
    },
    BacktestArgsDynamic {
        id: "strategy_v2".into(),
        risk_free_return: dec!(0.05),
        strategy: StrategyV2::new(),
        risk: RiskManagerV2::new(),
    },
    // ... æ›´å¤šç­–ç•¥å˜ä½“
];

// å¹¶å‘è¿è¡Œæ‰€æœ‰å›æµ‹
let multi_summary = run_backtests(args_constant, args_dynamic_iter).await?;

// åˆ†æç»“æœ
println!("æ€»å›æµ‹æ•°: {}", multi_summary.num_backtests);
println!("æ€»è€—æ—¶: {:?}", multi_summary.duration);

// æ‰¾åˆ°æœ€ä½³å›æµ‹
let best = multi_summary
    .summaries
    .iter()
    .max_by_key(|s| {
        // æ ¹æ®æŸä¸ªæŒ‡æ ‡æ’åºï¼Œä¾‹å¦‚æ€»ç›ˆäº
        s.trading_summary.instruments
            .values()
            .map(|tear| tear.pnl)
            .sum::<Decimal>()
    })
    .unwrap();

println!("æœ€ä½³å›æµ‹: {}", best.id);
best.trading_summary.print_summary();
```

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡åˆ†æ

### TradingSummary åŒ…å«çš„æŒ‡æ ‡

å›æµ‹å®Œæˆåï¼Œ`TradingSummary` åŒ…å«ä¸°å¯Œçš„æ€§èƒ½æŒ‡æ ‡ï¼š

#### 1. ç›ˆäºæŒ‡æ ‡ï¼ˆPnLï¼‰

-   **æ€»ç›ˆäº**ï¼šæ‰€æœ‰äº¤æ˜“å¯¹çš„æ€»ç›ˆäº
-   **å·²å®ç°ç›ˆäº**ï¼šå·²å¹³ä»“éƒ¨åˆ†çš„ç›ˆäº
-   **æœªå®ç°ç›ˆäº**ï¼šå½“å‰æŒä»“çš„ä¼°ç®—ç›ˆäº

#### 2. é£é™©è°ƒæ•´åæ”¶ç›Š

-   **Sharpe Ratioï¼ˆå¤æ™®æ¯”ç‡ï¼‰**ï¼šé£é™©è°ƒæ•´åæ”¶ç›ŠæŒ‡æ ‡
-   **Sortino Ratioï¼ˆç´¢æè¯ºæ¯”ç‡ï¼‰**ï¼šä¸‹è¡Œé£é™©è°ƒæ•´æ”¶ç›ŠæŒ‡æ ‡
-   **Calmar Ratioï¼ˆå¡ç›æ¯”ç‡ï¼‰**ï¼šæ”¶ç›Š/æœ€å¤§å›æ’¤æ¯”ç‡

#### 3. å›æ’¤æŒ‡æ ‡

-   **Max Drawdownï¼ˆæœ€å¤§å›æ’¤ï¼‰**ï¼šæœ€å¤§èµ„é‡‘å›æ’¤
-   **Mean Drawdownï¼ˆå¹³å‡å›æ’¤ï¼‰**ï¼šå¹³å‡å›æ’¤æ°´å¹³

#### 4. äº¤æ˜“ç»Ÿè®¡

-   **Win Rateï¼ˆèƒœç‡ï¼‰**ï¼šç›ˆåˆ©äº¤æ˜“å æ¯”
-   **Profit Factorï¼ˆç›ˆåˆ©å› å­ï¼‰**ï¼šæ€»ç›ˆåˆ©/æ€»äºæŸ
-   **äº¤æ˜“æ¬¡æ•°**ï¼šæ€»äº¤æ˜“ç¬”æ•°

### æŸ¥çœ‹å›æµ‹ç»“æœ

```rust
// æ‰“å°å®Œæ•´æ‘˜è¦
trading_summary.print_summary();

// è®¿é—®ç‰¹å®šæŒ‡æ ‡
let total_pnl = trading_summary
    .instruments
    .values()
    .map(|tear| tear.pnl)
    .sum::<Decimal>();

let sharpe_ratio = trading_summary
    .instruments
    .values()
    .next()
    .map(|tear| tear.sharpe_ratio);

println!("æ€»ç›ˆäº: {}", total_pnl);
println!("å¤æ™®æ¯”ç‡: {:?}", sharpe_ratio);
```

## ğŸ¯ ç­–ç•¥å‚æ•°ä¼˜åŒ–

### å‚æ•°ç½‘æ ¼æœç´¢

é€šè¿‡æ‰¹é‡å›æµ‹æµ‹è¯•ä¸åŒçš„å‚æ•°ç»„åˆï¼š

```rust
// å®šä¹‰å‚æ•°èŒƒå›´
let breakout_periods = vec![10, 20, 30, 40, 50];
let stop_loss_periods = vec![5, 10, 15, 20];
let position_sizes = vec![dec!(0.05), dec!(0.10), dec!(0.15)];

// ç”Ÿæˆæ‰€æœ‰å‚æ•°ç»„åˆ
let mut args_dynamic_iter = Vec::new();
for &breakout in &breakout_periods {
    for &stop_loss in &stop_loss_periods {
        for &position_size in &position_sizes {
            args_dynamic_iter.push(BacktestArgsDynamic {
                id: format!("b{}_s{}_p{}", breakout, stop_loss, position_size).into(),
                risk_free_return: dec!(0.05),
                strategy: BreakoutStrategy::new(breakout, stop_loss, position_size),
                risk: DefaultRiskManager::default(),
            });
        }
    }
}

// è¿è¡Œæ‰¹é‡å›æµ‹
let multi_summary = run_backtests(args_constant, args_dynamic_iter).await?;

// æ‰¾åˆ°æœ€ä½³å‚æ•°ç»„åˆ
let best = multi_summary
    .summaries
    .iter()
    .max_by_key(|s| {
        // æ ¹æ®å¤æ™®æ¯”ç‡é€‰æ‹©
        s.trading_summary.instruments
            .values()
            .next()
            .map(|tear| tear.sharpe_ratio)
            .unwrap_or(Decimal::ZERO)
    })
    .unwrap();
```

## âš ï¸ å›æµ‹æ³¨æ„äº‹é¡¹

### 1. æ•°æ®è´¨é‡

-   ç¡®ä¿å†å²æ•°æ®å®Œæ•´å‡†ç¡®
-   æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰ç¼ºå¤±æˆ–å¼‚å¸¸
-   éªŒè¯æ•°æ®æ—¶é—´æˆ³çš„æ­£ç¡®æ€§

### 2. é¿å…è¿‡æ‹Ÿåˆ

-   ä¸è¦è¿‡åº¦ä¼˜åŒ–å‚æ•°
-   ä½¿ç”¨æ ·æœ¬å¤–æ•°æ®éªŒè¯
-   ä¿æŒç­–ç•¥é€»è¾‘ç®€å•

### 3. è€ƒè™‘äº¤æ˜“æˆæœ¬

-   åœ¨å›æµ‹ä¸­åŒ…å«æ‰‹ç»­è´¹
-   è€ƒè™‘æ»‘ç‚¹å½±å“
-   ä½¿ç”¨åˆç†çš„æ‰§è¡Œå»¶è¿Ÿ

### 4. ç»“æœè§£è¯»

-   å›æµ‹ç»“æœä¸ä»£è¡¨æœªæ¥è¡¨ç°
-   å…³æ³¨é£é™©æŒ‡æ ‡ï¼Œä¸ä»…ä»…æ˜¯æ”¶ç›Š
-   è€ƒè™‘å¸‚åœºç¯å¢ƒçš„å˜åŒ–

## âœ… æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼Œç¡®ä¿ä½ æŒæ¡äº†å›æµ‹ç³»ç»Ÿï¼š

-   [ ] ç†è§£å›æµ‹çš„æ¦‚å¿µå’Œå±€é™æ€§
-   [ ] èƒ½å¤Ÿå‡†å¤‡å†å²å¸‚åœºæ•°æ®
-   [ ] èƒ½å¤Ÿè¿è¡Œå•ä¸ªå›æµ‹
-   [ ] èƒ½å¤Ÿè¿è¡Œæ‰¹é‡å¹¶å‘å›æµ‹
-   [ ] èƒ½å¤Ÿåˆ†æå›æµ‹ç»“æœ
-   [ ] çŸ¥é“å¦‚ä½•ä¼˜åŒ–ç­–ç•¥å‚æ•°

## ğŸ¯ ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»æŒæ¡äº†å›æµ‹ç³»ç»Ÿï¼Œå¯ä»¥ç»§ç»­å­¦ä¹ ï¼š

1.  **[08-å®ç›˜äº¤æ˜“](./08-å®ç›˜äº¤æ˜“.md)** - é…ç½®å’Œéƒ¨ç½²å®ç›˜äº¤æ˜“
2.  **[09-å¸¸è§é—®é¢˜](./09-å¸¸è§é—®é¢˜.md)** - æŸ¥æ‰¾é‡åˆ°çš„é—®é¢˜
3.  **[10-æœ€ä½³å®è·µ](./10-æœ€ä½³å®è·µ.md)** - äº†è§£æ›´å¤šå¼€å‘å»ºè®®

## ğŸ“š å»¶ä¼¸é˜…è¯»

-   [Backtest æ¨¡å—æ–‡æ¡£](https://docs.rs/barter/latest/barter/backtest/)
-   [TradingSummary æ–‡æ¡£](https://docs.rs/barter/latest/barter/statistic/summary/struct.TradingSummary.html)
-   [æœ¯è¯­è¡¨](./æœ¯è¯­è¡¨.md)

---

**å›æµ‹æ˜¯ç­–ç•¥éªŒè¯çš„é‡è¦æ­¥éª¤ï¼ŒåŠ¡å¿…è®¤çœŸå¯¹å¾…ï¼** ğŸ“Š
